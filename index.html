<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
  <title>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ö–≤–µ—Å—Ç –ö–ú–ë</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@500;700&display=swap" rel="stylesheet">

  <style>
    /* ================= –°–¢–ò–õ–ò ================= */
    :root {
      --gold: #ffc800; --red: #d42e2e; --green: #27ae60; --dark-bg: #151720;
      --modal-bg: linear-gradient(180deg, #8b0000 0%, #500000 100%);
      --modal-border: 3px solid #ffcc00;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
    body { margin: 0; padding: 0; overflow: hidden; font-family: 'Montserrat', sans-serif; background: #000; width: 100vw; height: 100vh; color: #fff; display: flex; justify-content: center; align-items: center; }
    
    #snow-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 9999; }
    .flake { position: absolute; background: #fff; border-radius: 50%; opacity: .8; animation: fall linear infinite; }
    @keyframes fall { to { transform: translateY(105vh); } }

    /* –ü–†–ï–õ–û–ê–î–ï–† */
    #preloader { position: absolute; inset: 0; background: #000; z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
    .loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.2); border-radius: 50%; border-top-color: var(--gold); animation: spin 1s linear infinite; margin-bottom: 20px; }
    .loader-text { color: var(--gold); font-weight: 900; letter-spacing: 2px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† (9:16) */
    #game-wrapper-fixed {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 500px;
      aspect-ratio: 9/16; 
      overflow: hidden;
      background: #000;
    }
    @media (min-aspect-ratio: 9/16) { #game-wrapper-fixed { height: 100vh; width: auto; } }

    /* –ö–ù–û–ü–ö–ò */
    .btn-start-orange { background: linear-gradient(to bottom, #ffb300, #ff8c00); color: #5a3a00; border: none; padding: 20px 50px; border-radius: 50px; font-size: 20px; font-weight: 900; letter-spacing: 1px; box-shadow: 0 10px 20px rgba(255, 140, 0, .4); cursor: pointer; text-transform: uppercase; animation: pulseBtn 2s infinite; display: inline-block; position: relative; z-index: 10001; }
    @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .btn-ny { width: 100%; max-width: 220px; border: none; border-radius: 18px; padding: 14px; cursor: pointer; font-weight: 900; letter-spacing: .5px; text-transform: uppercase; color: #fff; font-size: 14px; background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.35), transparent 40%), linear-gradient(180deg, #e53935, #b71c1c); box-shadow: 0 6px 0 #7f1010, 0 10px 20px rgba(0, 0, 0, .35); display: block; margin: 0 auto 30px auto; }
    .btn-ny:active { transform: translateY(3px); box-shadow: 0 3px 0 #7f1010; }
    .btn-main { background: linear-gradient(180deg, #ffae00, #ff8800); color: #4a3b00; border: none; padding: 18px 20px; border-radius: 16px; width: 100%; max-width: 280px; font-size: 16px; font-weight: 900; box-shadow: 0 6px 0 #c66a00; cursor: pointer; text-transform: uppercase; margin: 20px auto 0; display: block; position: relative; z-index: 50; }
    .btn-main:active { transform: translateY(4px); box-shadow: 0 2px 0 #c66a00; }
    .btn-check { width: 100%; padding: 14px; background: var(--green); color: #fff; font-weight: 900; border: none; border-radius: 10px; margin-top: 10px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 0 #1e8449; }
    .btn-check:active { transform: translateY(2px); box-shadow: 0 2px 0 #1e8449; }

    /* –≠–ö–†–ê–ù–´ */
    #start-screen, #letter-screen, #char-screen, #story-screen, #tutorial-screen, #interior-screen, #modal, #win-overlay, #alert-modal { position: absolute; inset: 0; display: none; justify-content: center; align-items: center; flex-direction: column; }
    #start-screen { display: flex; z-index: 10000; background-size: cover; background-position: center; justify-content: flex-end; padding-bottom: 80px; transition: opacity .8s; }
    .start-content { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; pointer-events: auto; }
    .social-icons { display: flex; justify-content: center; gap: 20px; width: 100%; margin-top: 10px; z-index: 10002; }
    .s-icon { width: 50px; height: 50px; background: rgba(255, 255, 255, .2); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, .3); text-decoration: none; }
    
    #letter-screen { z-index: 9000; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
    .letter-paper { position: relative; width: 90%; max-width: 320px; aspect-ratio: 9/14; background-position: center; background-size: 100% 100%; background-repeat: no-repeat; padding: 60px 30px 20px 30px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; color: #3e2723; }
    .letter-title { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 22px; color: #b30000; text-transform: uppercase; margin-top: 15px; margin-bottom: 5px; display: block; }
    .letter-body { font-family: 'Caveat', cursive; font-size: 24px; line-height: 1.3; font-weight: 700; margin-bottom: 10px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    
    #char-screen, #story-screen, #tutorial-screen { z-index: 8000; background-size: cover; }
    #char-screen::before, #story-screen::before, #tutorial-screen::before { content: ''; position: absolute; inset: 0; background: rgba(0, 0, 0, 0.85); z-index: -1; backdrop-filter: blur(3px); }
    .char-title { font-size: 24px; font-weight: 900; color: var(--gold); margin-bottom: 20px; text-align: center; text-transform: uppercase; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(255, 255, 255, .1); padding: 5px; border-radius: 30px; }
    .tab-btn { padding: 10px 20px; border: none; background: transparent; color: #aaa; font-weight: bold; cursor: pointer; border-radius: 20px; }
    .tab-btn.active { background: var(--gold); color: #000; }
    .char-grid { display: none; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .char-grid.active { display: grid; }
    .char-card { width: 140px; padding: 20px 10px; background: #222; border: 2px solid #444; border-radius: 16px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: .3s; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
    .char-card.selected { border-color: var(--gold); background: #332b00; transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 200, 0, 0.4); }
    .char-img-preview { width: 80px; height: 80px; margin-bottom: 15px; background-size: cover; border-radius: 50%; border: 2px solid #fff; }

    .chat-container { width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding: 0 15px; }
    .bubble { display: flex; gap: 14px; align-items: center; width: 100%; min-height: 100px; opacity: 0; transform: translateY(20px); transition: all .5s ease-out; background-size: 100% 100%; background-repeat: no-repeat; background-color: transparent !important; border: none !important; box-shadow: none !important; padding: 25px 30px; text-shadow: 0 1px 2px #000; }
    .bubble.mayor { background-image: var(--bubble-bg-left); }
    .bubble.hero { background-image: var(--bubble-bg-right); flex-direction: row-reverse; text-align: right; }
    .bubble.visible { opacity: 1; transform: translateY(0); }
    .avatar-icon { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--gold); background-size: cover; flex-shrink: 0; background-color: #333; margin: 0 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .msg-text { font-size: 15px; line-height: 1.4; font-weight: 700; color: #fff; flex: 1; }
    #story-btn { opacity: 0; transform: translateY(20px); transition: all .5s ease-out; }
    #story-btn.visible { opacity: 1; transform: translateY(0); }

    #map { position: absolute; inset: 0; background-color: #000; background-size: 100% 100%; background-position: center; z-index: 1000; transition: 1s; }
    #map.lit { filter: brightness(1.2); }
    #hero { position: absolute; width: 100px; height: 100px; background-size: contain; background-repeat: no-repeat; background-position: center bottom; z-index: 30; transition: top 1s linear, left 1s linear; pointer-events: none; }
    #hero.walking { animation: walkBob .3s infinite alternate; }
    @keyframes walkBob { from { transform: translate(-50%, -90%) rotate(-3deg); } to { transform: translate(-50%, -92%) rotate(3deg); } }
    
    .zone { 
        position: absolute; width: 100px; height: 100px; 
        transform: translate(-50%, -50%); 
        z-index: 10; cursor: pointer; 
    }
    
    /* –¢–ê–ë–õ–ò–ß–ö–ê –î–õ–Ø –ö–ê–†–£–°–ï–õ–ò (–ü–û–î–ù–Ø–¢–ê –ï–©–ï –í–´–®–ï) */
    .fortune-sign {
        position: absolute; 
        top: -100px; /* <--- –ü–æ–¥–Ω—è–ª–∏ –Ω–∞–¥ –∫—Ä—ã—à–µ–π */
        left: 110%; transform: translateX(-50%);
        background: rgba(0,0,0,0.85); color: var(--gold);
        padding: 6px 12px; border-radius: 8px; border: 2px solid var(--gold);
        font-size: 12px; font-weight: 900; white-space: nowrap;
        box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        pointer-events: none; 
        animation: signFloat 2s ease-in-out infinite;
        z-index: 20;
    }
    .fortune-sign::after {
        content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
        border-width: 6px 6px 0; border-style: solid; border-color: var(--gold) transparent transparent transparent;
    }
    @keyframes signFloat { 0%,100%{transform:translate(-50%,0);} 50%{transform:translate(-50%,-6px);} }

    .target-glow {
        position: absolute; top: 50%; left: 50%; width: 120px; height: 120px; transform: translate(-50%, -50%);
        background: radial-gradient(circle, rgba(255, 200, 0, 0.6) 0%, rgba(255, 100, 0, 0) 70%);
        border-radius: 50%; animation: pulseTarget 1.5s infinite; pointer-events: none;
    }
    @keyframes pulseTarget {
        0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.5; }
        50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.5; }
    }

    #hud { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 5000; display: none; flex-direction: column; align-items: center; background: rgba(0, 0, 0, .7); backdrop-filter: blur(5px); padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, .2); }
    .timer-row { display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 5px; }
    .timer { font-weight: 800; color: var(--gold); font-size: 18px; }
    #quest-text { font-size: 14px; font-weight: 900; color: #fff; text-transform: uppercase; text-align: center; }

    #interior-screen { z-index: 6000; background-color: #000; background-position: center; background-size: cover; background-repeat: no-repeat; }
    #modal, #win-overlay, #alert-modal { z-index: 6000; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
    .game-wrapper { background: var(--modal-bg); border: var(--modal-border); border-radius: 20px; padding: 25px; width: 95%; max-width: 400px; box-shadow: 0 0 20px rgba(255, 204, 0, 0.6); position: relative; animation: popUp .4s; display: flex; flex-direction: column; max-height: 85vh; overflow-y: auto; }
    .game-wrapper::before { content: '‚ùÑÔ∏è ‚ùÑÔ∏è ‚ùÑÔ∏è'; position: absolute; top: -15px; left: 0; right: 0; text-align: center; font-size: 20px; color: #fff; text-shadow: 0 0 5px #fff; pointer-events: none; }
    @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .interior-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 215, 0, 0.3); flex-shrink: 0; }
    .interior-title { font-size: 22px; font-weight: 900; color: var(--gold); text-transform: uppercase; text-shadow: 0 2px 4px #000; letter-spacing: 1px; }
    .close-btn { font-size: 32px; color: #fff; cursor: pointer; line-height: 1; }
    .game-icon { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

    /* === –°–¢–ò–õ–ò –í–ò–¢–†–ò–ù–´ === */
    .shelf-cabinet { 
      background-position: center; background-size: 100% 100%; background-repeat: no-repeat; 
      border: none; border-radius: 0; background-color: transparent; box-shadow: none;
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      grid-template-rows: repeat(3, 1fr);
      gap: 0; width: 100%; aspect-ratio: 1/1; 
    }
    .shelf-compartment { 
      position: relative; border: none; background: transparent;
      display: flex; justify-content: center; align-items: flex-end;
      padding-bottom: 5px; cursor: pointer;
    }
    .shelf-items-row {
        display: flex; justify-content: center; align-items: flex-end;
        width: 100%; height: 90%; 
    }
    .shelf-slot {
        width: 33%; height: 100%;
        display: flex; justify-content: center; align-items: flex-end;
        position: relative;
    }
    .shelf-slot img {
        width: 115%; height: 115%; object-fit: contain;
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));
        transition: transform 0.2s;
    }
    .shelf-slot.selected img {
        transform: scale(1.15) translateY(-5px);
        filter: drop-shadow(0 0 10px var(--gold));
    }
    .big-item { 
        position: absolute; inset: 0; 
        display: flex; justify-content: center; align-items: center; 
        z-index: 20; pointer-events: none; 
    }
    .big-item img { width: 70%; height: 70%; object-fit: contain; filter: drop-shadow(0 0 15px gold); }
    .shelf-done-mark { position: absolute; top: 2px; right: 2px; color: var(--green); font-size: 16px; background: #fff; border-radius: 50%; width: 22px; height: 22px; display: flex; justify-content: center; align-items: center; z-index: 21; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

    .collector-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .collector-card { position: relative; aspect-ratio: 1; border-radius: 12px; cursor: pointer; transform-style: preserve-3d; transition: transform .3s; }
    .collector-card.open { transform: rotateY(180deg); }
    .collector-face { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 12px; display: flex; justify-content: center; align-items: center; background-color: transparent !important; border: none !important; box-shadow: none !important; }
    .collector-front { transform: rotateY(180deg); background-color: rgba(255, 255, 255, 0.1) !important; }
    .collector-back { background-size: contain; background-position: center; background-repeat: no-repeat; }
    
    .m3-container { display: flex; flex-direction: column; align-items: center; width: 100%; }
    .m3-goals { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-shrink: 0; width: 100%; }
    .m3-goal-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.15); padding: 5px; border-radius: 10px; width: 60px; height: 70px; }
    .m3-goal-item img { width: 35px !important; height: 35px !important; object-fit: contain; margin-bottom: 4px; display: block; }
    .m3-goal-item.done::after { content: '‚úî'; position: absolute; top: -5px; right: -5px; background: var(--green); border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; justify-content: center; align-items: center; }
    .m3-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; background: rgba(0, 0, 0, 0.4); padding: 8px; border-radius: 10px; margin-bottom: 10px; width: 100%; max-width: 350px; aspect-ratio: 1 / 1; margin-left: auto; margin-right: auto; }
    .m3-cell { position: relative; background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; aspect-ratio: 1 / 1; }
    .m3-cell img { width: 80%; height: 80%; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); pointer-events: none; }
    .m3-cell.selected { background: rgba(255,255,255,0.5); border: 2px solid var(--gold); transform: scale(0.9); box-shadow: 0 0 10px var(--gold); }
    
    .quiz-question { font-size: 16px; margin-bottom: 15px; font-weight: bold; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; border-left: 4px solid var(--gold); }
    .quiz-opt { background: rgba(255, 255, 255, 0.1); padding: 15px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; font-size: 14px; border: 2px solid rgba(255, 255, 255, 0.1); }
    .quiz-opt.correct { background: rgba(46, 204, 113, .3); border-color: var(--green); }
    .quiz-opt.wrong { background: rgba(212, 46, 46, .3); border-color: var(--red); }
    .quiz-explanation { display: none; margin-top: 10px; padding: 10px; background: rgba(0, 0, 0, 0.4); border-radius: 8px; font-size: 13px; color: #fff; line-height: 1.4; }
    .quiz-opt.show-exp .quiz-explanation { display: block; animation: slideDown 0.3s; }
    @keyframes slideDown { from{opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }
    .quiz-counter { text-align: right; font-size: 14px; color: var(--gold); margin-bottom: 5px; font-weight: 800; }
    
    .cfo-question-box { background: #fff; color: #333; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
    .cfo-price { font-size: 24px; font-weight: 900; color: var(--red); margin: 10px 0; }
    .cfo-actions { display: flex; gap: 10px; margin-top: 15px; }
    .cfo-btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: 800; color: #fff; cursor: pointer; }
    
    #final-tree-visual { width: 160px; height: 220px; margin: 0 auto 15px; background-position: center; background-size: contain; background-repeat: no-repeat; transition: filter 0.2s, opacity 0.5s; opacity: 0.3; filter: grayscale(1); }
    #bar-bg { width: 100%; height: 24px; background: #222; border-radius: 12px; overflow: hidden; border: 2px solid #555; margin-bottom: 15px; }
    #bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff8c00, #ffeb3b); transition: width .1s; }
    #final-btn { width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, #ff5252, #b71c1c); border: 4px solid #fff; box-shadow: 0 0 20px #ff0000; margin: 0 auto; display: flex; justify-content: center; align-items: center; font-weight: 900; font-size: 18px; cursor: pointer; }
    
    .game-note { background: rgba(200, 0, 0, 0.9); color: #fff; padding: 10px 20px; border-radius: 20px; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); z-index: 3000; display: none; font-weight: bold; width: 80%; text-align: center; }
    .game-note.show { display: block; animation: fadeOut 2.5s forwards; }
    @keyframes fadeOut { 0% { opacity: 1; transform: translate(-50%, 0); } 10% { transform: translate(-50%, -5px); } 80% { opacity: 1; } 100% { opacity: 0; transform: translate(-50%, -20px); } }
    .win-icon { font-size: 60px; margin-bottom: 10px; }
    .win-text { font-size: 24px; color: var(--gold); text-transform: uppercase; font-weight: 900; margin-bottom: 10px; }
    
    #tutorial-screen .game-wrapper { text-align: center; }
    .tut-list { text-align: left; margin: 20px 0; font-size: 16px; line-height: 1.6; color: #eee; }
    .tut-list li { margin-bottom: 10px; }
  </style>
</head>
<body>

<div id="game-wrapper-fixed">

<!-- –ü–†–ï–õ–û–ê–î–ï–† -->
<div id="preloader">
    <div class="loader-spinner"></div>
    <div class="loader-text">–ó–ê–ì–†–£–ó–ö–ê...</div>
</div>

<script>
  const GAME_CONFIG = {
    images: {
      bg_loading:   'img/loading.jpg',
      map_0: 'img/map_0.jpg',
      map_1: 'img/map_1.jpg',
      map_2: 'img/map_2.jpg',
      map_3: 'img/map_3.jpg',
      map_4: 'img/map_4.jpg',
      map_5: 'img/map_5.jpg',
      map_final: 'img/tree_final_map.jpg',
      letter_bg:    'img/letter_bg.png',
      bubble_left:  'img/bubble_left.png',
      bubble_right: 'img/bubble_right.png',
      bg_admin:     'img/interier/bg_admin.jpg',
      bg_toys:      'img/interier/bg_toys.jpg',
      bg_bank:      'img/interier/bg_bank.jpg',
      bg_wine:      'img/interier/bg_wine.jpg',
      bg_shelf:     'img/interier/bg_shelf.jpg',
      bg_fortune:   'img/interier/bg_fortune.jpg',
      card_back:    'img/card_back.png', 
      shelf_bg:     'img/shelf_bg.png',   
      tree_final:   'img/tree_final.png',
      mayor:        'img/avatar/avatar-mayor.png'
    },
    characters: {
      boy:   { avatar: 'img/avatar/portret_man.png',   sprite: 'img/sprite/man.png' },
      girl:  { avatar: 'img/avatar/portret_girl.png',  sprite: 'img/sprite/girl.png' },
      santa: { avatar: 'img/avatar/portret_moroz.png', sprite: 'img/sprite/moroz.png' },
      snow:  { avatar: 'img/avatar/portret_snow.png',  sprite: 'img/sprite/snow.png' }
    },
    heroPhrases: {
        boy: "–ó–∞–¥–∞—á–∞ —è—Å–Ω–∞. –ü—Ä–∏–º–µ–Ω–∏–º –∞–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å–Ω—ã–π –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç!",
        girl: "–Ø —Å–æ—Å—Ç–∞–≤–ª—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é. –Ø—Ä–º–∞—Ä–∫–∞ —Å—Ç–∞–Ω–µ—Ç —Å–∞–º–æ–π –ø—Ä–∏–±—ã–ª—å–Ω–æ–π!",
        santa: "–û—Ö–æ-—Ö–æ! –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, –º—ç—Ä! –ß—É–¥–µ—Å–∞ ‚Äî –º–æ—è —Ä–∞–±–æ—Ç–∞!",
        snow: "–ú—ã —É–∫—Ä–∞—Å–∏–º –∫–∞–∂–¥—ã–π —É–≥–æ–ª–æ–∫! –ë—É–¥–µ—Ç –æ—á–µ–Ω—å —É—é—Ç–Ω–æ –∏ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω–æ!"
    },
    heroStops: {
      'start':{ top: 84, left: 71 }, 
      '1': { top: 68, left: 23 }, 
      '2': { top: 84, left: 82 }, 
      '3': { top: 92, left: 32 }, 
      '4': { top: 50, left: 29 }, 
      '5': { top: 49, left: 66 }, 
      '6': { top: 61, left: 60 }, 
      'tree': { top: 56, left: 39 } 
    },
    shelf: { itemSize: '95%', itemOffsetY: '0%' }, 
    collector: { itemSize: '80%' } 
  };

  const ASSETS = {
    collector: [ 'img/toy-1.png', 'img/toy-2.png', 'img/toy-4.png', 'img/toy-5.png' ],
    match3: [ {id:'wine', img:'img/wine.png'}, {id:'orange', img:'img/orange.png'}, {id:'cinnamon', img:'img/cinnamon.png'}, {id:'clove', img:'img/clove.png'} ],
    shelf: [ 
        'img/shelf_item1.png', 'img/shelf_item2.png', 'img/shelf_item3.png', 
        'img/shelf_item4.png', 'img/shelf_item5.png', 'img/shelf_item6.png', 
        'img/shelf_item7.png', 'img/shelf_item8.png', 'img/shelf_item9.png' 
    ]
  };
</script>

<div id="snow-canvas"></div>

<div id="start-screen">
  <div class="start-content">
    <button class="btn-start-orange" onclick="goToLetter()">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
    <div class="social-icons">
      <a href="https://google.com" target="_blank" class="s-icon">üåê</a>
      <a href="https://t.me/durov" target="_blank" class="s-icon">‚úàÔ∏è</a>
    </div>
  </div>
</div>

<div id="letter-screen">
  <div class="letter-paper">
    <div class="letter-title">–°–†–û–ß–ù–û–ï –ü–ò–°–¨–ú–û</div>
    <div class="letter-body">–î–æ—Ä–æ–≥–∏–µ –¥—Ä—É–∑—å—è!<br>–Ø—Ä–º–∞—Ä–∫–∞ –≤ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏!<br>–ù—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å 5 —Ç–æ—á–µ–∫ –∏ –∑–∞–∂–µ—á—å –Å–ª–∫—É!</div>
    <button class="btn-ny" onclick="goToCharSelection()">–ü–†–ò–ù–Ø–¢–¨ –í–´–ó–û–í</button>
  </div>
</div>

<div id="char-screen">
  <div class="char-title">–í–´–ë–ï–†–ò–¢–ï –ì–ï–†–û–Ø</div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('biz', this)">–ë–∏–∑–Ω–µ—Å</button>
    <button class="tab-btn" onclick="switchTab('ny', this)">–ù–æ–≤—ã–π –ì–æ–¥</button>
  </div>
  <div id="grid-biz" class="char-grid active">
    <div class="char-card selected" onclick="selectHero('boy', '–ë–∏–∑–Ω–µ—Å–º–µ–Ω', this)"><div class="char-img-preview" id="p-boy"></div><div>–ë–∏–∑–Ω–µ—Å–º–µ–Ω</div></div>
    <div class="char-card" onclick="selectHero('girl', '–ë–∏–∑–Ω–µ—Å-–ª–µ–¥–∏', this)"><div class="char-img-preview" id="p-girl"></div><div>–ë–∏–∑–Ω–µ—Å-–ª–µ–¥–∏</div></div>
  </div>
  <div id="grid-ny" class="char-grid">
    <div class="char-card" onclick="selectHero('santa', '–î–µ–¥ –ú–æ—Ä–æ–∑', this)"><div class="char-img-preview" id="p-santa"></div><div>–î–µ–¥ –ú–æ—Ä–æ–∑</div></div>
    <div class="char-card" onclick="selectHero('snow', '–°–Ω–µ–≥—É—Ä–æ—á–∫–∞', this)"><div class="char-img-preview" id="p-snow"></div><div>–°–Ω–µ–≥—É—Ä–æ—á–∫–∞</div></div>
  </div>
  <button class="btn-main" onclick="confirmHero()">–í–´–ë–†–ê–¢–¨</button>
</div>

<div id="story-screen">
  <div class="chat-container">
    <div class="bubble mayor" id="bubble-mayor">
      <div class="avatar-icon" id="av-mayor"></div>
      <div class="msg-text">"–ù–∞–¥–µ–∂–¥–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–±—è! –õ–∞–≤–∫–∏ —Å—Ç–æ—è—Ç –±–µ–∑ –¥–µ–ª–∞. –ù—É–∂–Ω–æ –≤—Å—ë –∏—Å–ø—Ä–∞–≤–∏—Ç—å!"</div>
    </div>
    <div class="bubble hero" id="bubble-hero">
      <div class="avatar-icon" id="av-hero"></div>
      <div class="msg-text">"–ó–∞–¥–∞—á–∞ —è—Å–Ω–∞. –°–µ–π—á–∞—Å –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ–º!"</div>
    </div>
  </div>
  <button id="story-btn" class="btn-main" onclick="startTutorial()">–ü–û–ï–•–ê–õ–ò! üöÄ</button>
</div>

<div id="tutorial-screen">
    <div class="game-wrapper">
        <div style="font-size:24px; font-weight:900; color:var(--gold); margin-bottom:15px;">–ò–ù–°–¢–†–£–ö–¶–ò–Ø</div>
        <ul class="tut-list">
            <li>üè† <b>–ü–æ—Ä—è–¥–æ–∫:</b> –î–æ–º–∏–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ –æ—á–µ—Ä–µ–¥–∏. –°–ª–µ–¥–∏ –∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏!</li>
            <li>üîÆ <b>–ì–∞–¥–∞–ª–∫–∞:</b> –ú–æ–∂–µ—à—å –∑–∞–π—Ç–∏ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.</li>
            <li>üéÑ <b>–§–∏–Ω–∞–ª:</b> –ö–æ–≥–¥–∞ –ø—Ä–æ–π–¥—ë—à—å 5 —Ç–æ—á–µ–∫, –∑–∞–∂–≥–∏ –Å–ª–∫—É!</li>
        </ul>
        <button class="btn-check" onclick="closeTutorialAndStart()">–í–°–Å –ü–û–ù–Ø–¢–ù–û</button>
    </div>
</div>

<div id="hud">
  <div class="timer-row">
      <div style="font-weight:bold; font-size:14px">üéÑ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: <span id="score" style="color:var(--gold)">0</span>/5</div>
      <div class="timer">10:00</div>
  </div>
  <div id="quest-text">–û–ñ–ò–î–ê–ù–ò–ï...</div>
</div>

<div id="map">
  <div id="hero"></div>
  <div id="z3" class="zone" onclick="moveHeroTo('3')"></div>
  <div id="z4" class="zone" onclick="moveHeroTo('4')"></div>
  <div id="z1" class="zone" onclick="moveHeroTo('1')"></div>
  <div id="z5" class="zone" onclick="moveHeroTo('5')"></div>
  <div id="z2" class="zone" onclick="moveHeroTo('2')"></div>
  <!-- –ó–û–ù–ê –ö–ê–†–£–°–ï–õ–ò (–ì–ê–î–ê–õ–ö–ê) –° –¢–ê–ë–õ–ò–ß–ö–û–ô -->
  <div id="z6" class="zone" style="display:block" onclick="moveHeroTo('6')">
      <div class="fortune-sign">üîÆ –£–ó–ù–ê–ô –£–î–ê–ß–£</div>
  </div>
  <div id="z-main" class="zone" style="display:block" onclick="moveHeroTo('tree')"></div>
</div>

<div id="interior-screen">
  <div class="game-wrapper">
    <div class="interior-header">
      <span class="interior-title" id="int-title">–ò–ì–†–ê</span>
      <span class="close-btn" onclick="exitInterior()">‚úï</span>
    </div>
    <div id="int-desc" style="font-size:14px; color:#eee; margin-bottom:15px; text-align:center;"></div>
    <div id="game-container"></div>
    <div class="game-note"></div>
  </div>
</div>

<div id="win-overlay">
  <div class="game-wrapper" style="text-align:center;">
    <div id="win-content"></div>
  </div>
</div>

<div id="modal">
  <div class="game-wrapper">
    <div class="interior-header">
      <span class="interior-title" id="m-title">–ò–ù–§–û</span>
      <span class="close-btn" onclick="closeModal()">‚úï</span>
    </div>
    <div id="m-desc" style="margin-bottom:15px; color:#eee; text-align:center;"></div>
    <div id="game-area"></div>
  </div>
</div>

<div id="alert-modal">
  <div class="game-wrapper" style="text-align:center;">
    <div style="font-size:50px; margin-bottom:10px;">üéÑ‚ö†Ô∏è</div>
    <div style="font-size:18px; font-weight:bold; color:var(--gold); margin-bottom:10px;">–†–ê–ù–û!</div>
    <div style="color:#eee; margin-bottom:20px; line-height:1.4;">–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –≤—Å–µ 5 —Ç–æ—á–µ–∫ –ø–æ –ø–æ—Ä—è–¥–∫—É! –°–ª–µ–¥—É–π –ø–æ–¥—Å–∫–∞–∑–∫–∞–º.</div>
    <button class="btn-check" onclick="document.getElementById('alert-modal').style.display='none'">–ü–û–ù–Ø–¢–ù–û</button>
  </div>
</div>

</div>

<script>
  let selectedHeroId = 'boy';
  let currentLoc = { top:90, left:90 }; 
  let isMoving = false;
  const done = new Set();
  let currentLevelId = 0;
  
  let levelTimer; 
  let gameInterval; 
  let isGameFinished = false; 

  let quizIndex = 0;
  let quizScore = 0; 
  let cfoBudget = 40000;
  let cfoIndex = 0;
  let currentQuizQuestions = [];
  let gameStartTime;

  const LEVEL_ORDER = [3, 4, 1, 5, 2];
  const LEVEL_NAMES = {3:"–í–ê–õ–ï–ù–ö–ò", 4:"–ù–ê–ü–ò–¢–ö–ò", 1:"–ò–ì–†–£–®–ö–ò", 5:"–í–´–ü–ï–ß–ö–ê", 2:"–õ–ï–î–ï–ù–¶–´"};
  let currentOrderIndex = 0;

  // –ü–†–ï–õ–û–ê–î–ï–† –õ–û–ì–ò–ö–ê
  window.onload = () => { 
      preloadImages(() => {
          document.getElementById('preloader').style.opacity = 0;
          setTimeout(() => { 
              document.getElementById('preloader').style.display = 'none'; 
              initGame(); 
          }, 500);
      });
  };

  function preloadImages(callback) {
      let imagesToLoad = [
          GAME_CONFIG.images.bg_loading,
          GAME_CONFIG.images.letter_bg,
          GAME_CONFIG.images.map_0
      ];
      for (let k in GAME_CONFIG.characters) {
          imagesToLoad.push(GAME_CONFIG.characters[k].avatar);
          imagesToLoad.push(GAME_CONFIG.characters[k].sprite);
      }

      let loadedCount = 0;
      let total = imagesToLoad.length;
      
      const checkDone = () => {
          loadedCount++;
          if (loadedCount >= total) callback();
      };

      if (total === 0) callback();

      imagesToLoad.forEach(src => {
          const img = new Image();
          img.src = src;
          img.onload = checkDone;
          img.onerror = checkDone; 
      });
      
      setTimeout(callback, 3000);
  }

  function initGame() {
    const s = document.getElementById('start-screen');
    s.style.backgroundImage = `url('${GAME_CONFIG.images.bg_loading}')`;
    document.querySelector('.letter-paper').style.backgroundImage = `url('${GAME_CONFIG.images.letter_bg}')`;
    document.documentElement.style.setProperty('--bubble-bg-left', `url('${GAME_CONFIG.images.bubble_left}')`);
    document.documentElement.style.setProperty('--bubble-bg-right', `url('${GAME_CONFIG.images.bubble_right}')`);
    document.getElementById('p-boy').style.backgroundImage = `url('${GAME_CONFIG.characters.boy.avatar}')`;
    document.getElementById('p-girl').style.backgroundImage = `url('${GAME_CONFIG.characters.girl.avatar}')`;
    document.getElementById('p-santa').style.backgroundImage = `url('${GAME_CONFIG.characters.santa.avatar}')`;
    document.getElementById('p-snow').style.backgroundImage = `url('${GAME_CONFIG.characters.snow.avatar}')`;
    document.getElementById('av-mayor').style.backgroundImage = `url('${GAME_CONFIG.images.mayor}')`;

    setMapStage(0); 
    
    for(let k in GAME_CONFIG.heroStops) {
        if(k==='tree') {
            const z = document.getElementById('z-main');
            z.style.top = GAME_CONFIG.heroStops[k].top + '%';
            z.style.left = GAME_CONFIG.heroStops[k].left + '%';
        } else if (k !== 'start') {
            const z = document.getElementById('z'+k);
            if(z) {
                z.style.top = GAME_CONFIG.heroStops[k].top + '%';
                z.style.left = GAME_CONFIG.heroStops[k].left + '%';
            }
        }
    }
    initSnow();
  }

  function initSnow(){ const cont = document.getElementById('snow-canvas'); setInterval(() => { const f = document.createElement('div'); f.className='flake'; f.style.left = Math.random()*100+'vw'; f.style.width = f.style.height = (Math.random()*5+2)+'px'; f.style.animationDuration = (Math.random()*3+2)+'s'; cont.appendChild(f); setTimeout(()=>f.remove(), 5000); }, 200); }
  
  function setMapStage(stageNum){ 
      if (stageNum === 'final') {
          document.getElementById('map').style.backgroundImage = `url('${GAME_CONFIG.images.map_final}')`;
      } else {
          document.getElementById('map').style.backgroundImage = `url('${GAME_CONFIG.images['map_'+stageNum]}')`; 
      }
  }
  
  function goToLetter() { document.getElementById('start-screen').style.opacity = 0; setTimeout(() => { document.getElementById('start-screen').style.display = 'none'; document.getElementById('letter-screen').style.display = 'flex'; }, 800); }
  function goToCharSelection() { document.getElementById('letter-screen').style.display='none'; document.getElementById('char-screen').style.display='flex'; }
  function switchTab(t, b) { document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active')); b.classList.add('active'); document.querySelectorAll('.char-grid').forEach(g=>g.classList.remove('active')); document.getElementById('grid-'+t).classList.add('active'); }
  function selectHero(id, name, el) { selectedHeroId = id; document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('selected')); el.classList.add('selected'); }
  
  function confirmHero() { 
      const start = GAME_CONFIG.heroStops['start'];
      const hero = document.getElementById('hero');
      hero.style.backgroundImage = `url('${GAME_CONFIG.characters[selectedHeroId].sprite}')`; 
      hero.style.top = start.top + '%';
      hero.style.left = start.left + '%';
      currentLoc = start;

      document.getElementById('av-hero').style.backgroundImage = `url('${GAME_CONFIG.characters[selectedHeroId].avatar}')`; 
      const heroMsgText = GAME_CONFIG.heroPhrases[selectedHeroId];
      document.querySelector('#bubble-hero .msg-text').innerText = `"${heroMsgText}"`;

      document.getElementById('char-screen').style.display='none'; document.getElementById('story-screen').style.display='flex'; 
      setTimeout(()=>document.getElementById('bubble-mayor').classList.add('visible'), 100); 
      setTimeout(()=> { document.getElementById('bubble-hero').classList.add('visible'); document.getElementById('story-btn').classList.add('visible'); }, 1000); 
  }
  
  function startTutorial() {
      document.getElementById('story-screen').style.display = 'none';
      document.getElementById('tutorial-screen').style.display = 'flex';
  }

  function closeTutorialAndStart() {
      document.getElementById('tutorial-screen').style.display = 'none';
      document.getElementById('hud').style.display = 'flex';
      gameStartTime = Date.now();
      let t=600; 
      gameInterval = setInterval(()=>{ 
          t--; 
          if(t>=0) { 
              let m=Math.floor(t/60).toString().padStart(2,'0'); 
              let s=(t%60).toString().padStart(2,'0'); 
              document.querySelector('.timer').innerText = m+":"+s; 
          }
      }, 1000); 
      
      activateCurrentLevel();
  }
  
  function activateCurrentLevel() {
      if (currentOrderIndex >= LEVEL_ORDER.length) {
          document.getElementById('quest-text').innerText = "–í–°–Å –ì–û–¢–û–í–û! –ò–î–ò –ö –Å–õ–ö–ï üéÑ";
          document.getElementById('quest-text').style.color = "#00ff00";
          return;
      }
      let lvlId = LEVEL_ORDER[currentOrderIndex];
      let el = document.getElementById('z' + lvlId);
      
      if(el) {
          el.style.display = 'block'; 
          el.innerHTML = '<div class="target-glow"></div>';
      }
      
      let name = LEVEL_NAMES[lvlId];
      document.getElementById('quest-text').innerText = "–¶–ï–õ–¨: –û–¢–ö–†–´–¢–¨ –î–û–ú–ò–ö " + name;
  }

  async function moveHeroTo(id) {
    if(isMoving) return;
    
    if (id !== '6' && id !== 'tree') {
        let currentTarget = LEVEL_ORDER[currentOrderIndex];
        if (parseInt(id) !== currentTarget && !done.has(parseInt(id))) {
            showNote("–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ —Ç–µ–∫—É—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ!");
            return;
        }
    }

    const target = GAME_CONFIG.heroStops[id];
    if(!target) return;
    
    isMoving = true;
    const h = document.getElementById('hero');
    h.classList.add('walking');
    h.style.transform = (target.left < currentLoc.left) ? "translate(-50%,-90%) scaleX(-1)" : "translate(-50%,-90%) scaleX(1)";
    h.style.top = target.top + '%';
    h.style.left = target.left + '%';
    
    await new Promise(r=>setTimeout(r, 1000));
    h.classList.remove('walking');
    currentLoc = target;
    isMoving = false;
    
    if(id==='tree') clickTree();
    else { if(id!=='6' && done.has(parseInt(id))) return; enterInterior(id); }
  }

  const LEVELS = { 
    1: {type:'collector', t:'–°–ö–õ–ê–î', d:'–ù–∞–π–¥–∏ –ø–∞—Ä—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∏–≥—Ä—É—à–µ–∫. –¢—Ä–µ–Ω–∏—Ä—É–π –ø–∞–º—è—Ç—å!'}, 
    2: {type:'quiz', t:'–ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø', d:'–†–µ—à–∞–π –ø—Ä–æ–±–ª–µ–º—ã –±–∏–∑–Ω–µ—Å–∞. –í—ã–±–∏—Ä–∞–π —Ç–æ–ª—å–∫–æ –≤–µ—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è!'}, 
    3: {type:'cfo', t:'–ë–Æ–î–ñ–ï–¢', d:'–†–∞—Å–ø—Ä–µ–¥–µ–ª—è–π —Ñ–∏–Ω–∞–Ω—Å—ã. –ù–µ –¥–∞–π –±—é–¥–∂–µ—Ç—É —É–π—Ç–∏ –≤ –º–∏–Ω—É—Å!'}, 
    4: {type:'match3', t:'–ì–õ–ò–ù–¢–í–ï–ô–ù', d:'–ú–µ–Ω—è–π –º–µ—Å—Ç–∞–º–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å 3 –≤ —Ä—è–¥.'}, 
    5: {type:'shelf', t:'–í–ò–¢–†–ò–ù–ê', d:'–ù–∞–∂–∏–º–∞–π –Ω–∞ —Ç–æ–≤–∞—Ä—ã, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –∏—Ö. –°–æ–±–µ—Ä–∏ –ø–æ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –Ω–∞ –ø–æ–ª–∫–µ.'}, 
    6: {type:'fortune', t:'–ì–ê–î–ê–õ–ö–ê', d:'–£–∑–Ω–∞–π —Å–≤–æ–µ –¥–µ–ª–æ–≤–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ 2025 –≥–æ–¥!'} 
  };

  function enterInterior(id) {
    currentLevelId = id;
    const lvl = LEVELS[id];
    const s = document.getElementById('interior-screen');
    let bgKey = 'bg_' + (id==='1'?'toys': id==='2'?'admin': id==='3'?'bank': id==='4'?'wine': id==='5'?'shelf': 'fortune');
    s.style.backgroundImage = `url('${GAME_CONFIG.images[bgKey]}')`;
    s.style.display='flex';
    document.getElementById('int-title').innerText = lvl.t;
    document.getElementById('int-desc').innerText = lvl.d;
    document.getElementById('game-container').innerHTML = '';
    if(lvl.type === 'cfo') { cfoBudget = 40000; cfoIndex = 0; }
    if(lvl.type === 'quiz') { 
        quizIndex = 0; 
        quizScore = 0; 
        initQuizQuestions(); 
    }
    if(lvl.type==='fortune') openFortune();
    else document.getElementById('game-container').innerHTML = `<button class="btn-check" onclick="launchGame('${lvl.type}')">–ò–ì–†–ê–¢–¨</button>`;
  }

  function exitInterior() { document.getElementById('interior-screen').style.display='none'; }

  function launchGame(type) {
    const r = document.getElementById('game-container');
    r.innerHTML='';
    if(type==='collector') playCollector(r);
    if(type==='quiz') playQuiz(r);
    if(type==='cfo') playCFO(r);
    if(type==='match3') playMatch3(r);
    if(type==='shelf') playShelf(r);
  }

  function playCollector(r) {
    let deck = [...ASSETS.collector, ...ASSETS.collector, ...ASSETS.collector].slice(0,12).sort(()=>Math.random()-.5);
    let opened=[], found=0;
    let backStyle = `background-image: url('${GAME_CONFIG.images.card_back}')`;
    r.innerHTML=`<div class="collector-grid">${deck.map((src,i)=>`<div class="collector-card" id="c-${i}" onclick="flipC(${i},'${src}')"><div class="collector-face collector-back" style="${backStyle}"></div><div class="collector-face collector-front"><img src="${src}" class="game-icon" style="width:${GAME_CONFIG.collector.itemSize};height:${GAME_CONFIG.collector.itemSize}"></div></div>`).join('')}</div>`;
    window.flipC = (i,src) => {
      const el = document.getElementById('c-'+i);
      if(el.classList.contains('open') || opened.length>=3) return;
      el.classList.add('open');
      opened.push({i,src});
      if(opened.length===3) {
        if(opened[0].src===opened[1].src && opened[1].src===opened[2].src) {
          found++; opened=[];
          if(found===4) showWin('collector');
        } else {
          showNote("–†–∞–∑–Ω—ã–µ!");
          setTimeout(()=>{ opened.forEach(o=>document.getElementById('c-'+o.i).classList.remove('open')); opened=[]; }, 800);
        }
      }
    };
  }

  const QUIZ_POOL = [{t:"–ü–æ—Å—Ç–∞–≤—â–∏–∫ —Ç—Ä–µ–±—É–µ—Ç 100% –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É –Ω–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.",a:[{t:"–ü–ª–∞—Ç–∏–º, —Å—Ä–æ—á–Ω–æ –Ω—É–∂–µ–Ω —Ç–æ–≤–∞—Ä!",ok:false,exp:"–û–ø–∞—Å–Ω–æ! –ë–µ–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –≥–∞—Ä–∞–Ω—Ç–∏–π –¥–µ–Ω—å–≥–∏ –º–æ–≥—É—Ç –ø—Ä–æ–ø–∞—Å—Ç—å. –í—Å–µ–≥–¥–∞ —Ñ–∏–∫—Å–∏—Ä—É–π —Å–¥–µ–ª–∫—É."},{t:"–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å 50/50 –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É",ok:true,exp:"–í–µ—Ä–Ω–æ! –†–∞–∑–±–∏–≤–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ –∏ –¥–æ–≥–æ–≤–æ—Ä —Å–Ω–∏–∂–∞—é—Ç —Ä–∏—Å–∫–∏. –î–µ–Ω—å–≥–∏ –ª—é–±—è—Ç —Å—á–µ—Ç –∏ –ø–æ—Ä—è–¥–æ–∫."}]},{t:"–ì–ª–∞–≤–Ω—ã–π –∞–Ω–∏–º–∞—Ç–æ—Ä –∑–∞–±–æ–ª–µ–ª –∑–∞ —á–∞—Å –¥–æ –Ω–∞—á–∞–ª–∞ —à–æ—É.",a:[{t:"–û—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ",ok:false,exp:"–≠—Ç–æ —É–¥–∞—Ä –ø–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏! –ö–ª–∏–µ–Ω—Ç—ã —É–π–¥—É—Ç —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ –∏ –±–æ–ª—å—à–µ –Ω–µ –≤–µ—Ä–Ω—É—Ç—Å—è."},{t:"–°—Ä–æ—á–Ω–æ –Ω–∞–π—Ç–∏ –∑–∞–º–µ–Ω—É",ok:true,exp:"–û—Ç–ª–∏—á–Ω–æ! –í –±–∏–∑–Ω–µ—Å–µ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–ª–∞–Ω '–ë'. –®–æ—É –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å—Å—è!"}]},{t:"–í —Å–æ—Ü—Å–µ—Ç—è—Ö –ø–æ—è–≤–∏–ª—Å—è –≥–Ω–µ–≤–Ω—ã–π –æ—Ç–∑—ã–≤ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞.",a:[{t:"–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",ok:false,exp:"–ü–ª–æ—Ö–∞—è –∏–¥–µ—è. –≠—Ç–æ —Ä–∞–∑–æ–∑–ª–∏—Ç –∫–ª–∏–µ–Ω—Ç–∞ –µ—â–µ –±–æ–ª—å—à–µ. –¶–µ–Ω–∑—É—Ä–∞ —É–±–∏–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ."},{t:"–í–µ–∂–ª–∏–≤–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –∏ –ø–æ–º–æ—á—å",ok:true,exp:"–°—É–ø–µ—Ä! –ì—Ä–∞–º–æ—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –Ω–µ–≥–∞—Ç–∏–≤–æ–º –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ö–µ–π—Ç–µ—Ä–∞ –≤ –ª–æ—è–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞."}]},{t:"–í–Ω–µ–∑–∞–ø–Ω–æ –æ—Ç–∫–ª—é—á–∏–ª–∏ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ –Ω–∞ –≤—Å–µ–π —è—Ä–º–∞—Ä–∫–µ.",a:[{t:"–ó–∞–∫—Ä—ã—Ç—å—Å—è –¥–æ –∑–∞–≤—Ç—Ä–∞",ok:false,exp:"–ü—Ä–æ—Å—Ç–æ–π —Å—Ç–æ–∏—Ç –¥–µ–Ω–µ–≥! –ê—Ä–µ–Ω–¥–∞ –∫–∞–ø–∞–µ—Ç, –∞ –≤—ã—Ä—É—á–∫–∏ –Ω–µ—Ç."},{t:"–ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä",ok:true,exp:"–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–ø–∞—Å–∞–µ—Ç –≤—ã—Ä—É—á–∫—É. –ö–ª–∏–µ–Ω—Ç—ã –æ—Ü–µ–Ω—è—Ç —Ç–≤–æ—é –Ω–∞—Ö–æ–¥—á–∏–≤–æ—Å—Ç—å."}]},{t:"–ü—Ä–∏—à–ª–∞ –≤–Ω–µ–ø–ª–∞–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∂–∞—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",a:[{t:"–ù–µ –ø—É—Å–∫–∞—Ç—å –∏ —Å–ø–æ—Ä–∏—Ç—å",ok:false,exp:"–û—à–∏–±–∫–∞! –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –æ—Ä–≥–∞–Ω–∞–º–∏ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —à—Ç—Ä–∞—Ñ–∞–º –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç–∏—é."},{t:"–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã",ok:true,exp:"–í–µ—Ä–Ω–æ! –ï—Å–ª–∏ –±–∏–∑–Ω–µ—Å '–±–µ–ª—ã–π' –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π, –±–æ—è—Ç—å—Å—è –Ω–µ—á–µ–≥–æ."}]},{t:"–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç –Ω–∞–ø—Ä–æ—Ç–∏–≤ —Å–Ω–∏–∑–∏–ª —Ü–µ–Ω—ã –≤ 2 —Ä–∞–∑–∞.",a:[{t:"–¢–æ–∂–µ —Å–Ω–∏–∑–∏—Ç—å —Ü–µ–Ω—ã",ok:false,exp:"–î–µ–º–ø–∏–Ω–≥ ‚Äî –ø—É—Ç—å –≤ –Ω–∏–∫—É–¥–∞. –í—ã –æ–±–∞ –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –ø—Ä–∏–±—ã–ª—å –∏ —Ä–∞–∑–æ—Ä–∏—Ç–µ—Å—å."},{t:"–£–ª—É—á—à–∏—Ç—å —Å–µ—Ä–≤–∏—Å",ok:true,exp:"–¢–æ—á–Ω–æ! –õ—é–¥–∏ –ø–ª–∞—Ç—è—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –∑–∞ —Ç–æ–≤–∞—Ä, –Ω–æ –∏ –∑–∞ —ç–º–æ—Ü–∏–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–æ."}]},{t:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –≥—Ä—É–±–∏—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º.",a:[{t:"–£–≤–æ–ª–∏—Ç—å –±–µ–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤",ok:false,exp:"–†–µ–∑–∫–æ. –°–Ω–∞—á–∞–ª–∞ —Å—Ç–æ–∏—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –ø—Ä–∏—á–∏–Ω–µ, –æ–±—É—á–µ–Ω–∏–µ –¥–µ—à–µ–≤–ª–µ –Ω–∞–π–º–∞ –Ω–æ–≤–æ–≥–æ."},{t:"–ü—Ä–æ–≤–µ—Å—Ç–∏ –±–µ—Å–µ–¥—É",ok:true,exp:"–ú—É–¥—Ä–æ. –í–æ–∑–º–æ–∂–Ω–æ, —á–µ–ª–æ–≤–µ–∫ –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–ª. –û–±—É—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–º–æ–∂–µ—Ç."}]},{t:"–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Å–∞–º—ã–π —Ö–æ–¥–æ–≤–æ–π —Ç–æ–≤–∞—Ä.",a:[{t:"–ü—Ä–æ–¥–∞–≤–∞—Ç—å —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å",ok:false,exp:"–£–ø—É—â–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å! –ö–ª–∏–µ–Ω—Ç—ã —É–π–¥—É—Ç –∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º –∑–∞ –Ω—É–∂–Ω—ã–º —Ç–æ–≤–∞—Ä–æ–º."},{t:"–°—Ä–æ—á–Ω—ã–π –¥–æ–∑–∞–∫–∞–∑",ok:true,exp:"–í–µ—Ä–Ω–æ! –ê–Ω–∞–ª–∏–∑ –∑–∞–ø–∞—Å–æ–≤ ‚Äî –∫–ª—é—á –∫ –≤—ã—Å–æ–∫–∏–º –ø—Ä–æ–¥–∞–∂–∞–º. –ü–æ–ª–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø—É—Å—Ç–æ–≤–∞—Ç—å."}]},{t:"–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Å–∫–∏–¥–∫—É, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –ø—Ä–∞–π—Å–µ.",a:[{t:"–ì—Ä—É–±–æ –æ—Ç–∫–∞–∑–∞—Ç—å",ok:false,exp:"–ö–ª–∏–µ–Ω—Ç –æ–±–∏–¥–∏—Ç—Å—è –∏ —É–π–¥–µ—Ç. –ì–∏–±–∫–æ—Å—Ç—å ‚Äî –≤–∞–∂–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–≤—Ü–∞."},{t:"–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –±–æ–Ω—É—Å",ok:true,exp:"–•–∏—Ç—Ä–æ! –ù–µ —Å–Ω–∏–∂–∞—è —Ü–µ–Ω—É, —Ç—ã –¥–∞—ë—à—å —Ü–µ–Ω–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫—Ä–∞—Å–∏–≤—É—é —É–ø–∞–∫–æ–≤–∫—É)."}]},{t:"–í—ã—Ä—É—á–∫–∞ —É–ø–∞–ª–∞ –∏–∑-–∑–∞ –ø–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥—ã.",a:[{t:"–°–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã",ok:true,exp:"–†–∞–∑—É–º–Ω–æ. –í '–Ω–∏–∑–∫–∏–π —Å–µ–∑–æ–Ω' –Ω—É–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±—é–¥–∂–µ—Ç, —á—Ç–æ–±—ã –≤—ã–∂–∏—Ç—å."},{t:"–í–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç –Ω–∞ —Ä–µ–∫–ª–∞–º—É",ok:false,exp:"–†–∏—Å–∫–æ–≤–∞–Ω–Ω–æ! –í –∫—Ä–∏–∑–∏—Å –¥–æ–ª–≥–∏ –º–æ–≥—É—Ç —É—Ç—è–Ω—É—Ç—å –Ω–∞ –¥–Ω–æ. –õ—É—á—à–µ —ç–∫–æ–Ω–æ–º–∏—Ç—å."}]},{t:"–ù–∞—à–ª–∏ –æ—à–∏–±–∫—É –≤ –Ω–∞–ª–æ–≥–æ–≤–æ–π –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏.",a:[{t:"–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å",ok:false,exp:"–û–ø–∞—Å–Ω–æ! –ù–∞–ª–æ–≥–æ–≤–∞—è –≤—Å—ë —Ä–∞–≤–Ω–æ —É–∑–Ω–∞–µ—Ç, –∏ –±—É–¥–µ—Ç —à—Ç—Ä–∞—Ñ –ø–ª—é—Å –ø–µ–Ω–∏."},{t:"–ü–æ–¥–∞—Ç—å —É—Ç–æ—á–Ω—ë–Ω–∫—É",ok:true,exp:"–ß–µ—Å—Ç–Ω–æ! –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ —á–∞—Å—Ç–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –æ—Ç —à—Ç—Ä–∞—Ñ–æ–≤."}]},{t:"–ü–æ—è–≤–∏–ª–∞—Å—å –∏–¥–µ—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞, –Ω–æ –¥–µ–Ω–µ–≥ –º–∞–ª–æ.",a:[{t:"–°–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø (MVP)",ok:true,exp:"–í–µ—Ä–Ω–æ! –°–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º —Å–ø—Ä–æ—Å –º–∞–ª–æ–π –∫—Ä–æ–≤—å—é, –ø–æ—Ç–æ–º –≤–∫–ª–∞–¥—ã–≤–∞–µ–º –º–∏–ª–ª–∏–æ–Ω—ã."},{t:"–í–ª–æ–∂–∏—Ç—å –≤—Å—ë –≤ –∑–∞–ø—É—Å–∫",ok:false,exp:"–û—à–∏–±–∫–∞ –≤—ã–∂–∏–≤—à–µ–≥–æ. –ï—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –Ω–µ –∑–∞–π–¥–µ—Ç, —Ç—ã –ø–æ—Ç–µ—Ä—è–µ—à—å –≤—Å—ë."}]}];
  function initQuizQuestions() { currentQuizQuestions = QUIZ_POOL.sort(() => 0.5 - Math.random()).slice(0, 5); }
  function playQuiz(r) {
    function renderQuiz() { if(quizIndex >= currentQuizQuestions.length) { showWin('quiz'); return; } let cur = currentQuizQuestions[quizIndex]; r.innerHTML = `<div class="quiz-counter">–í–æ–ø—Ä–æ—Å: ${quizIndex + 1}/5</div><div class="quiz-question">${cur.t}</div><div id="quiz-options-container">${cur.a.map((opt, i)=>`<div class="quiz-opt" id="q-opt-${i}" onclick="checkQ(${i})">${opt.t}<div class="quiz-explanation" id="exp-${i}">${opt.exp}</div></div>`).join('')}</div><div id="quiz-next-btn" style="display:none; margin-top:10px;"></div>`; }
    window.checkQ = (optIdx) => { if(document.querySelector('.quiz-opt.correct')) return; let cur = currentQuizQuestions[quizIndex]; let ans = cur.a[optIdx]; let el = document.getElementById(`q-opt-${optIdx}`); el.classList.add('show-exp'); if(ans.ok) { el.classList.add('correct'); document.getElementById(`quiz-next-btn`).style.display = 'block'; document.getElementById(`quiz-next-btn`).innerHTML = `<button class="btn-check" onclick="nextQ()">–î–ê–õ–ï–ï</button>`; } else { el.classList.add('wrong'); } };
    window.nextQ = () => { quizIndex++; renderQuiz(); }; renderQuiz();
  }

  function playCFO(r) {
    const items = [{t:"–°–≤–µ—Ç –∏ –ó–≤—É–∫", c:15000, must:true, icon:"üí°"}, {t:"–õ–µ–¥—è–Ω–æ–π —Ç—Ä–æ–Ω", c:25000, must:false, icon:"‚ùÑÔ∏è"}, {t:"–û—Ö—Ä–∞–Ω–∞", c:20000, must:true, icon:"üëÆ‚Äç‚ôÇÔ∏è"}, {t:"–§–µ–π–µ—Ä–≤–µ—Ä–∫", c:10000, must:false, icon:"üéÜ"}];
    function renderCFO() { if(cfoIndex >= items.length) { showWin('cfo'); return; } if(cfoBudget < 0) { showNote("–ë–∞–Ω–∫—Ä–æ—Ç! –ó–∞–Ω–æ–≤–æ."); cfoBudget = 40000; cfoIndex = 0; } let item = items[cfoIndex]; r.innerHTML = `<div class="brief">–ë—é–¥–∂–µ—Ç: <b style="color:var(--gold); font-size:18px;">${cfoBudget}‚ÇΩ</b></div><div class="cfo-question-box"><div class="cfo-icon">${item.icon}</div><div style="font-size:18px; font-weight:bold; margin-bottom:5px;">${item.t}</div><div class="cfo-price">${item.c}‚ÇΩ</div><div style="font-size:12px; color:#666;">–ë–µ—Ä—ë–º –∏–ª–∏ —ç–∫–æ–Ω–æ–º–∏–º?</div></div><div class="cfo-actions"><button class="cfo-btn" style="background:var(--red)" onclick="pay(false)">–û–¢–ö–ê–ó–ê–¢–¨</button><button class="cfo-btn" style="background:var(--green)" onclick="pay(true)">–û–ü–õ–ê–¢–ò–¢–¨</button></div>`; }
    window.pay = (doPay) => { const item = items[cfoIndex]; if(doPay){ if(cfoBudget >= item.c) { cfoBudget -= item.c; cfoIndex++; renderCFO(); } else showNote("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!"); } else { if(item.must) showNote("–≠—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!"); else { cfoIndex++; renderCFO(); } } }; renderCFO();
  }

  function playMatch3(r) {
    const W=5, H=5; let board=[], selected=-1; let goals={wine:10, orange:5, cinnamon:5, clove:5}; let collected={wine:0, orange:0, cinnamon:0, clove:0}; let processing = false;
    function init() { board=[]; for(let i=0; i<W*H; i++) board.push(getRandomItem()); resolveSequence(); }
    function getRandomItem() { return ASSETS.match3[Math.floor(Math.random() * ASSETS.match3.length)]; }
    function render() { let done = Object.keys(goals).every(k => collected[k] >= goals[k]); if(done) { showWin('match3'); return; } let htmlGoals = ASSETS.match3.map(t => `<div class="m3-goal-item ${collected[t.id]>=goals[t.id]?'done':''}"><img src="${t.img}"><span style="font-size:12px">${collected[t.id]}/${goals[t.id]}</span></div>`).join(''); let gridHtml = ''; for(let i=0; i<W*H; i++) { let item = board[i]; let inner = item ? `<img src="${item.img}">` : ''; let cls = `m3-cell ${selected === i ? 'selected' : ''}`; gridHtml += `<div class="${cls}" onclick="clkM3(${i})">${inner}</div>`; } r.innerHTML = `<div class="m3-container"><div class="m3-goals">${htmlGoals}</div><div class="m3-grid">${gridHtml}</div></div>`; }
    window.clkM3 = (i) => { if(processing) return; if(selected === -1) { selected = i; render(); } else if (selected === i) { selected = -1; render(); } else { let r1 = Math.floor(selected / W), c1 = selected % W; let r2 = Math.floor(i / W), c2 = i % W; if (Math.abs(r1 - r2) + Math.abs(c1 - c2) === 1) { processing = true; let temp = board[selected]; board[selected] = board[i]; board[i] = temp; let oldSel = selected; selected = -1; render(); if (!hasMatches()) { setTimeout(() => { let temp = board[oldSel]; board[oldSel] = board[i]; board[i] = temp; processing = false; render(); }, 300); } else { setTimeout(() => resolveSequence(), 300); } } else { selected = i; render(); } } };
    function hasMatches() { for (let r = 0; r < H; r++) { for (let c = 0; c < W - 2; c++) { let i = r * W + c; if (board[i] && board[i+1] && board[i+2] && board[i].id === board[i+1].id && board[i].id === board[i+2].id) return true; } } for (let c = 0; c < W; c++) { for (let r = 0; r < H - 2; r++) { let i = r * W + c; if (board[i] && board[i+W] && board[i+2*W] && board[i].id === board[i+W].id && board[i].id === board[i+2*W].id) return true; } } return false; }
    function resolveSequence() { let matches = new Set(); for (let r = 0; r < H; r++) { for (let c = 0; c < W - 2; c++) { let i = r * W + c; if (board[i] && board[i+1] && board[i+2] && board[i].id === board[i+1].id && board[i].id === board[i+2].id) { matches.add(i); matches.add(i+1); matches.add(i+2); } } } for (let c = 0; c < W; c++) { for (let r = 0; r < H - 2; r++) { let i = r * W + c; if (board[i] && board[i+W] && board[i+2*W] && board[i].id === board[i+W].id && board[i].id === board[i+2*W].id) { matches.add(i); matches.add(i+W); matches.add(i+2*W); } } } if (matches.size > 0) { matches.forEach(idx => { if (board[idx]) { let id = board[idx].id; if (collected[id] < goals[id]) collected[id]++; board[idx] = null; } }); render(); setTimeout(() => { applyGravity(); fillEmpty(); render(); setTimeout(() => resolveSequence(), 300); }, 300); } else { processing = false; } }
    function applyGravity() { for (let c = 0; c < W; c++) { for (let r = H - 1; r >= 0; r--) { let idx = r * W + c; if (board[idx] === null) { for (let k = r - 1; k >= 0; k--) { let aboveIdx = k * W + c; if (board[aboveIdx] !== null) { board[idx] = board[aboveIdx]; board[aboveIdx] = null; break; } } } } } }
    function fillEmpty() { for (let i = 0; i < W * H; i++) { if (board[i] === null) board[i] = getRandomItem(); } }
    init(); render();
  }

  // --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê "–í–ò–¢–†–ò–ù–ê" (9 –ø–æ–ª–æ–∫, 1 —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç) ---
  function playShelf(r) {
    let itemsForGame = ASSETS.shelf.slice(0, 9); 
    let deck = [];

    // 8 –ø–æ–ª–Ω—ã—Ö –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤
    for(let i=0; i<8; i++) {
        let it = itemsForGame[i];
        deck.push(it, it, it);
    }
    // 1 –Ω–µ–ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç (2 —à—Ç)
    let lastItem = itemsForGame[8];
    deck.push(lastItem, lastItem);
    // 1 –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ
    deck.push(null);

    deck.sort(() => Math.random() - 0.5);
    
    let slots = deck; 
    let selected = -1; 
    let doneShelves = new Array(9).fill(false); 
    let sets = 0; 
    const TARGET_SETS = 9; 
    
    let shelfStyle = `background-image: url('${GAME_CONFIG.images.shelf_bg}');`;
    window.finishedImages = new Array(9).fill(null);

    const render = function() { 
        let h = `<div class="shelf-cabinet" style="${shelfStyle}">`; 
        for(let i=0; i<9; i++) { 
            let isDone = doneShelves[i]; 
            h += `<div class="shelf-compartment" onclick="clkShelfArea(${i})">`; 
            if(isDone) {
                 h += `<div class="big-item"><img src="${window.finishedImages[i]}"></div><div class="shelf-done-mark">‚úî</div>`;
            } else {
                 h += `<div class="shelf-items-row">`;
                 h += slotHtml(i*3); 
                 h += slotHtml(i*3+1); 
                 h += slotHtml(i*3+2); 
                 h += `</div>`;
            }
            h += `</div>`; 
        } 
        h += `</div><div style="text-align:center;margin-top:10px">–°–æ–±—Ä–∞–Ω–æ: ${sets}/${TARGET_SETS}</div>`; 
        r.innerHTML = h; 
    }

    function slotHtml(idx) { 
        let img = slots[idx] ? `<img src="${slots[idx]}">` : ''; 
        let cls = selected===idx ? 'shelf-slot selected' : 'shelf-slot'; 
        return `<div class="${cls}" onclick="event.stopPropagation(); clkSlot(${idx})">${img}</div>`; 
    }

    window.clkSlot = (i) => { 
        let shelfIdx = Math.floor(i / 3);
        if(doneShelves[shelfIdx]) return;

        if(slots[i]) { 
            selected = i; 
            render(); 
        } else if (selected !== -1) { 
            moveItem(selected, i);
        } 
    }

    window.clkShelfArea = (shelfIndex) => {
        if (selected === -1) return;
        if (doneShelves[shelfIndex]) return;

        let start = shelfIndex * 3;
        let emptyIdx = -1;
        if (!slots[start]) emptyIdx = start;
        else if (!slots[start+1]) emptyIdx = start+1;
        else if (!slots[start+2]) emptyIdx = start+2;
        
        if (emptyIdx !== -1) {
            moveItem(selected, emptyIdx);
        }
    }

    function moveItem(fromIdx, toIdx) {
        let oldShelf = Math.floor(fromIdx / 3); 
        let newShelf = Math.floor(toIdx / 3); 
        
        slots[toIdx] = slots[fromIdx]; 
        slots[fromIdx] = null; 
        selected = -1; 
        
        checkShelf(newShelf); 
        render(); 
    }

    function checkShelf(i) { 
        let s1 = slots[i*3], s2 = slots[i*3+1], s3 = slots[i*3+2]; 
        if(s1 && s2 && s3 && s1 === s2 && s2 === s3) { 
            if(!doneShelves[i]) { 
                completeShelf(i, s1);
            } 
        } 
    }
    
    function completeShelf(shelfIdx, itemSrc) {
        doneShelves[shelfIdx] = true; 
        sets++; 
        window.finishedImages[shelfIdx] = itemSrc; 
        slots[shelfIdx*3] = null; 
        slots[shelfIdx*3+1] = null; 
        slots[shelfIdx*3+2] = null;
        if(sets === 8) {
            setTimeout(autoCompleteLastShelf, 600);
        }
    }
    
    function autoCompleteLastShelf() {
        let lastShelfIdx = doneShelves.findIndex(s => s === false);
        if (lastShelfIdx !== -1) {
            let lastItemSrc = itemsForGame[8]; 
            doneShelves[lastShelfIdx] = true;
            sets++;
            window.finishedImages[lastShelfIdx] = lastItemSrc;
            slots[lastShelfIdx*3] = null; 
            slots[lastShelfIdx*3+1] = null; 
            slots[lastShelfIdx*3+2] = null;
            render();
            setTimeout(() => showWin('shelf'), 1500); 
        }
    }
    render();
  }

  function openFortune() { const FORTUNES = ["–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã —É–π–¥—É—Ç –≤ –¥–µ–∫—Ä–µ—Ç!", "–ù–∞–ª–æ–≥–æ–≤–∞—è –∑–∞–±—É–¥–µ—Ç —Ç–≤–æ–π –Ω–æ–º–µ—Ä.", "–¢–≤–æ–π —Å—Ç–∞—Ä—Ç–∞–ø –∫—É–ø–∏—Ç –ì–µ—Ä–º–∞–Ω –ì—Ä–µ—Ñ.", "–û—Ç–∫—Ä–æ–µ—à—å —Ñ–∏–ª–∏–∞–ª –Ω–∞ –ë–∞–ª–∏.", "–ö–ª–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –ø–ª–∞—Ç–∏—Ç—å –≤–ø–µ—Ä–µ–¥!", "–ù–∞–π–¥–µ—à—å –∫–ª–∞–¥ –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏.", "–¢–≤–æ–π –±—Ä–µ–Ω–¥ —Å—Ç–∞–Ω–µ—Ç –ª–µ–≥–µ–Ω–¥–æ–π.", "–í—Å—è –∫–æ–º–∞–Ω–¥–∞ –≤—ã–π–¥–µ—Ç –≤–æ–≤—Ä–µ–º—è!", "–ò–Ω–≤–µ—Å—Ç–æ—Ä –Ω–∞–π–¥–µ—Ç—Å—è —Å–∞–º.", "–ü—Ä–∏–±—ã–ª—å –≤—ã—Ä–∞—Å—Ç–µ—Ç –≤ 10 —Ä–∞–∑!"]; let txt = FORTUNES[Math.floor(Math.random()*FORTUNES.length)]; document.getElementById('game-container').innerHTML = `<div class="fortune-box" style="font-size:20px; text-align:center; margin:20px 0; color:var(--gold); font-weight:bold;">${txt}</div><br><button class="btn-check" onclick="finishLvl()">–°–ü–ê–°–ò–ë–û!</button>`; }

  const WIN_DATA = { 'collector': { title: "–°–ö–õ–ê–î –ì–û–¢–û–í! üß∏", text: "–ü–æ—Ä—è–¥–æ–∫ –Ω–∞–≤–µ–¥—ë–Ω! –¢–µ–ø–µ—Ä—å –Ω–∏ –æ–¥–Ω–∞ –∏–≥—Ä—É—à–∫–∞ –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è, –∏ –¥–µ—Ç–∏ –ø–æ–ª—É—á–∞—Ç –ø–æ–¥–∞—Ä–∫–∏ –≤–æ–≤—Ä–µ–º—è. –õ–∞–≤–∫–∞ –∏–≥—Ä—É—à–µ–∫ –æ—Ç–∫—Ä—ã—Ç–∞!" }, 'quiz': { title: "–¢–´ ‚Äî –õ–ò–î–ï–†! üé©", text: "–ö—Ä–∏–∑–∏—Å –º–∏–Ω–æ–≤–∞–ª! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã. –¢—ã –±–ª–µ—Å—Ç—è—â–µ —Ä–∞–∑—Ä—É–ª–∏–ª –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã." }, 'cfo': { title: "–ë–Æ–î–ñ–ï–¢ –°–ü–ê–°–ï–ù! üí∞", text: "–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –≥–µ–Ω–∏–π! –°—á–µ—Ç–∞ –æ–ø–ª–∞—á–µ–Ω—ã, –ª–∏—à–Ω–µ–µ –Ω–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ. –ö–∞–∑–Ω–∞—á–µ–π—Å—Ç–≤–æ –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ." }, 'shelf': { title: "–í–ò–¢–†–ò–ù–ê –ò–î–ï–ê–õ–¨–ù–ê! ü•ñ", text: "–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –≤—ã–∫–ª–∞–¥–∫–∞! –ü–µ–∫–∞—Ä–Ω—è –≥–æ—Ç–æ–≤–∞ –∫ –Ω–∞–ø–ª—ã–≤—É –≥–æ—Å—Ç–µ–π, –≤—Å–µ –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –∞–ø–ø–µ—Ç–∏—Ç–Ω–æ." }, 'match3': { title: "–£–†–ê! –õ–ê–í–ö–ê –û–¢–ö–†–´–¢–ê! üç∑", text: `–ë–ª–∞–≥–æ–¥–∞—Ä—è —Ç–µ–±–µ –∞—Ä–æ–º–∞—Ç —Å–ø–µ—Ü–∏–π —Å–Ω–æ–≤–∞ –º–∞–Ω–∏—Ç –≥–æ—Å—Ç–µ–π. –¢—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –º–∞—Å—Ç–µ—Ä —É—é—Ç–∞!<br><br><b>–¢–≤–æ–π –±–æ–Ω—É—Å ‚Äî —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç:</b><br><br>üçí 1–ª –í–∏—à–Ω–µ–≤–æ–≥–æ —Å–æ–∫–∞<br>üçä 1 –ê–ø–µ–ª—å—Å–∏–Ω (–∫—Ä—É–∂–æ—á–∫–∞–º–∏)<br>ü™µ 1 –ø–∞–ª–æ—á–∫–∞ –ö–æ—Ä–∏—Ü—ã, 3 –≥–≤–æ–∑–¥–∏–∫–∏<br>üçØ –ù–µ–º–Ω–æ–≥–æ –º—ë–¥–∞ –∏ –∏–º–±–∏—Ä—è<br><br><i>–ù–∞–≥—Ä–µ—Ç—å, –Ω–µ –¥–æ–≤–æ–¥—è –¥–æ –∫–∏–ø–µ–Ω–∏—è. –î–∞—Ç—å –Ω–∞—Å—Ç–æ—è—Ç—å—Å—è 10 –º–∏–Ω.</i>` } };
  function showWin(type) { const d = WIN_DATA[type]; const ov = document.getElementById('win-overlay'); ov.style.display='flex'; confetti({particleCount:150, zIndex:3000}); document.getElementById('win-content').innerHTML = `<div class="win-icon">üéâ</div><div class="win-text">${d.title}</div><div style="color:#ccc; margin-bottom:20px; text-align:left; font-size:16px; line-height:1.4">${d.text}</div><button class="btn-check" onclick="finishLvl()">–û–¢–õ–ò–ß–ù–û</button>`; }

  function finishLvl() {
    document.getElementById('win-overlay').style.display='none';
    exitInterior();
    if(currentLevelId==='6') return; 
    if(!done.has(parseInt(currentLevelId))) {
      done.add(parseInt(currentLevelId));
      let zone = document.getElementById('z'+currentLevelId);
      
      zone.innerHTML = '';
      zone.classList.remove('active');
      zone.classList.add('done');
      
      setMapStage(done.size);
      document.getElementById('score').innerText = done.size;
      
      currentOrderIndex++;
      activateCurrentLevel();
    }
    if(done.size===5) {
      setTimeout(()=>{
        // –°–ö–†–´–í–ê–ï–ú –í–°–ï –ó–û–ù–´ –ö–†–û–ú–ï –ï–õ–ö–ò –ò –ö–ê–†–£–°–ï–õ–ò (z6)
        document.querySelectorAll('.zone:not(#z-main):not(#z6)').forEach(e=>e.style.display='none');
        document.getElementById('z-main').style.display = 'block'; 
        
        document.getElementById('modal').style.display='flex';
        document.getElementById('m-title').innerText="–ì–û–¢–û–í–û!";
        document.getElementById('m-desc').innerText="–≠–Ω–µ—Ä–≥–∏—è —Å–æ–±—Ä–∞–Ω–∞. –ó–∞–∂–≥–∏ —ë–ª–∫—É!";
        document.getElementById('game-area').innerHTML=`<button class="btn-check" onclick="closeModal()">–ö –Å–õ–ö–ï!</button>`;
      }, 600);
    }
  }

  function clickTree() {
    if(isGameFinished) { showFinalResult(); return; }
    if(done.size < 5) { document.getElementById('alert-modal').style.display = 'flex'; return; }
    const m = document.getElementById('modal'); m.style.display='flex';
    document.getElementById('m-title').innerText="–§–ò–ù–ê–õ";
    document.getElementById('m-desc').innerText="–¢–∞–ø–∞–π –±—ã—Å—Ç—Ä–æ!";
    let treeStyle = `background-image: url('${GAME_CONFIG.images.tree_final}');`;
    document.getElementById('game-area').innerHTML=`<div id="final-tree-visual" style="${treeStyle}"></div><div id="bar-bg"><div id="bar-fill"></div></div><div id="final-btn" ontouchstart="tapTree()" onmousedown="tapTree()">–ñ–ú–ò</div>`;
    startFinalGame();
  }

  let power=0;
  function startFinalGame() {
    power=0;
    levelTimer = setInterval(()=>{ if(power>0) { power-=1; if(power<0) power=0; updTree(); } }, 50);
  }
  window.tapTree = () => {
    power+=15; if(power>100) power=100; updTree();
    if(power>=100) {
      clearInterval(levelTimer);
      clearInterval(gameInterval); 
      isGameFinished = true; 

      document.getElementById('modal').style.display='none';
      setMapStage('final'); 
      document.getElementById('map').classList.add('lit');
      confetti({particleCount:500, spread:150, zIndex:9999});
      
      setTimeout(showFinalResult, 1000);
    }
  }
  function updTree() {
    document.getElementById('bar-fill').style.width = power+'%';
    let t = document.getElementById('final-tree-visual');
    t.style.opacity = 0.3 + (power/100)*0.7;
    t.style.filter = `grayscale(${1-power/100}) drop-shadow(0 0 ${power/3}px gold)`;
  }

  function showFinalResult() {
      let now = Date.now();
      let diffInSeconds = Math.floor((now - gameStartTime) / 1000); 

      let m = Math.floor(diffInSeconds / 60).toString().padStart(2, '0');
      let s = (diffInSeconds % 60).toString().padStart(2, '0');
      let timeString = `${m}:${s}`;

      const mElem = document.getElementById('modal');
      mElem.style.display = 'flex';
      document.getElementById('m-title').innerText = "–¢–´ –ë–ò–ó–ù–ï–°-–ì–£–†–£!";
      document.getElementById('m-desc').innerHTML = ""; 
      
      document.getElementById('game-area').innerHTML = `
        <div style="text-align:center; color:#fff;">
            <p style="font-size:18px; margin-bottom:15px; font-weight:bold;">
                –ö–∞–∫ —Ç—ã —Ö–æ—Ä–æ—à–æ —Ä–∞–∑–±–∏—Ä–∞–µ—à—å—Å—è –≤ –±–∏–∑–Ω–µ—Å–µ!
            </p>
            <p style="font-size:16px; margin-bottom:20px;">
                –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ù–æ–≤—ã–º 2026 –ì–æ–¥–æ–º!<br>
                –ö–æ–º–∞–Ω–¥–∞ –ö–ú–ë
            </p>
            <div style="font-size:24px; color:var(--gold); font-weight:900; margin-bottom:25px;">
                –¢–í–û–Å –í–†–ï–ú–Ø: ${timeString}
            </div>
            <button class="btn-check" onclick="location.reload()" style="margin-bottom:10px;">–ü–†–û–ô–¢–ò –°–ù–ê–ß–ê–õ–ê</button>
            <button class="btn-main" onclick="shareResult('${timeString}')">–ü–û–î–ï–õ–ò–¢–¨–°–Ø</button>
        </div>
      `;
  }

  function shareResult(time) {
      const text = `–Ø —Å–ø–∞—Å —è—Ä–º–∞—Ä–∫—É –ö–ú–ë –∑–∞ ${time}! –ê —Ç—ã —Å–º–æ–∂–µ—à—å –±—ã—Å—Ç—Ä–µ–µ? üéÑ‚ú®`;
      const url = "t.me/KMBYearQuest_bot/kmbquest"; 
      const tgShareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
      window.open(tgShareUrl, '_blank');
  }

  function closeModal(){ document.getElementById('modal').style.display='none'; }
  function showNote(t){ const n=document.querySelector('.game-note'); n.innerText=t; n.classList.add('show'); setTimeout(()=>n.classList.remove('show'), 2500); }
</script>

</body>
</html>
